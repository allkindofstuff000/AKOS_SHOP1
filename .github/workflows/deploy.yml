name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PORT: ${{ vars.VPS_PORT }}
      REPO_URL: ${{ format('https://github.com/{0}.git', github.repository) }}
      REPO_BRANCH: main
      DEPLOY_ROOT: /opt/akosshop
      WEB_ROOT: /var/www/akosshop
      DOMAIN: akosshop.online
      DOMAIN_WWW: www.akosshop.online
      BACKEND_APP_NAME: akosshop-backend
      BACKEND_DIR: ${{ vars.BACKEND_DIR }}
      BACKEND_ENTRY: ${{ vars.BACKEND_ENTRY }}
      BACKEND_PORT: ${{ vars.BACKEND_PORT }}
      FRONTEND_DIR: ${{ vars.FRONTEND_DIR }}
      FRONTEND_BUILD_DIR: ${{ vars.FRONTEND_BUILD_DIR }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -Eeuo pipefail
          [[ -n "${VPS_HOST:-}" ]] || { echo "::error::Missing secret VPS_HOST"; exit 1; }
          [[ -n "${VPS_USER:-}" ]] || { echo "::error::Missing secret VPS_USER"; exit 1; }
          echo "[INFO] Secrets validation passed."

      - name: Prepare SSH key and known_hosts
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        shell: bash
        run: |
          set -Eeuo pipefail
          SSH_PORT="${VPS_PORT:-22}"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          [[ -n "${VPS_SSH_KEY:-}" ]] || { echo "::error::Missing secret VPS_SSH_KEY"; exit 1; }
          printf '%s\n' "$VPS_SSH_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$SSH_PORT" -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "[INFO] SSH key and known_hosts configured."

      - name: SSH handshake test
        shell: bash
        run: |
          set -Eeuo pipefail
          SSH_PORT="${VPS_PORT:-22}"
          ssh -i ~/.ssh/id_ed25519 \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$VPS_USER@$VPS_HOST" "echo SSH_OK"

      - name: Upload deploy scripts
        shell: bash
        run: |
          set -Eeuo pipefail
          SSH_PORT="${VPS_PORT:-22}"
          scp -i ~/.ssh/id_ed25519 \
            -P "$SSH_PORT" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            deploy/vps-update.sh \
            deploy/nginx-akosshop.conf \
            "$VPS_USER@$VPS_HOST:/tmp/"
          echo "[INFO] Uploaded deploy assets to /tmp on VPS."

      - name: Run remote deployment
        shell: bash
        run: |
          set -Eeuo pipefail
          SSH_PORT="${VPS_PORT:-22}"
          ssh -i ~/.ssh/id_ed25519 \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$VPS_USER@$VPS_HOST" \
            env \
              REPO_URL="$REPO_URL" \
              REPO_BRANCH="$REPO_BRANCH" \
              DEPLOY_ROOT="$DEPLOY_ROOT" \
              WEB_ROOT="$WEB_ROOT" \
              DOMAIN="$DOMAIN" \
              DOMAIN_WWW="$DOMAIN_WWW" \
              BACKEND_APP_NAME="$BACKEND_APP_NAME" \
              BACKEND_DIR="${BACKEND_DIR:-}" \
              BACKEND_ENTRY="${BACKEND_ENTRY:-}" \
              BACKEND_PORT="${BACKEND_PORT:-}" \
              FRONTEND_DIR="${FRONTEND_DIR:-}" \
              FRONTEND_BUILD_DIR="${FRONTEND_BUILD_DIR:-}" \
              NGINX_TEMPLATE="/tmp/nginx-akosshop.conf" \
              bash -lc "sed -i 's/\r$//' /tmp/vps-update.sh /tmp/nginx-akosshop.conf && chmod 700 /tmp/vps-update.sh && /tmp/vps-update.sh"

      - name: Post-deploy health check (non-blocking)
        shell: bash
        run: |
          set -Eeuo pipefail
          SSH_PORT="${VPS_PORT:-22}"
          HEALTH_PORT="${BACKEND_PORT:-5000}"
          ssh -i ~/.ssh/id_ed25519 \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$VPS_USER@$VPS_HOST" \
            "curl -f http://127.0.0.1:${HEALTH_PORT}/health || true"

      - name: Cleanup temporary deploy files
        if: always()
        shell: bash
        run: |
          set +e
          SSH_PORT="${VPS_PORT:-22}"
          ssh -i ~/.ssh/id_ed25519 \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "$VPS_USER@$VPS_HOST" \
            "rm -f /tmp/vps-update.sh /tmp/nginx-akosshop.conf"
